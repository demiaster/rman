#! /usr/bin/python
import getpass
import time
# import the python functions
import sys,os.path,subprocess

# import the python renderman library
import prman

###-------------------------------Function Section--------------------------###

"""
Jon Macey's function
function to check if shader exists and compile it, we assume that the shader
is .osl and the compiled shader is .oso If the shader source is newer than the
compiled shader we will compile it. It also assumes that oslc is in the path.
"""
def checkAndCompileShader(shader) :
	if os.path.isfile(shader+'.oso') != True  or os.stat(shader+'.osl').st_mtime - os.stat(shader+'.oso').st_mtime > 0 :
		print "compiling shader %s" %(shader)
		try :
			subprocess.check_call(["oslc", shader+".osl"])
		except subprocess.CalledProcessError :
			sys.exit("shader compilation failed")

# hyperboloid shapes in the pin
def hyperboloid_wrapper(height, base_radius, top_radius):
    ri.ArchiveRecord(ri.COMMENT, '--Hyperboloid Shape Generated by hyperboloid_wrapper Function--')
    ri.TransformBegin()
    ri.Rotate(-90, 1, 0, 0)
    p_base = [base_radius, 0, 0]
    p_top = [top_radius, 0, height]
    ri.Hyperboloid(p_base, p_top, 360)
    ri.TransformEnd()
    ri.ArchiveRecord(ri.COMMENT, '--!End of hyperboloid_wrapper Function!--')

# model pin
def Pin():
    ri.ArchiveRecord(ri.COMMENT, '--Pin Model Generated by Pin Function--')
    
    #-------------------metal part-------------------#
    # the pointy end
    baseColorMetal = [0.8, 0.8, 0.8]
    metallic = 1
    roughnessTip = 0.4
    roughnessStick = 0.1

    ri.TransformBegin()
    end_height = 0.35
    metal_radius = 0.06
    ri.Translate(0, end_height, 0)
    ri.TransformBegin()
    ri.AttributeBegin()
    ri.Rotate(90, 1, 0, 0)
    ri.Bxdf( "PxrDisney","bxdf", { 
                                  "color baseColor" : baseColorMetal    ,
                                  "float metallic": metallic,
                                  "float roughness": roughnessTip,
                                  "float specular" : [0.5]
                                 })
    ri.Cone(end_height, metal_radius, 360)
    ri.AttributeEnd()
    ri.TransformEnd()

    #the metal stick
    metal_height = 0.9
    ri.TransformBegin()
    ri.AttributeBegin()
    ri.Rotate(-90, 1, 0, 0)
    ri.Bxdf( "PxrDisney","bxdf", { 
                                  "color baseColor" : baseColorMetal,
                                  "float metallic": metallic,
                                  "float roughness": roughnessStick,
                                  "float specular" : [0.5]
                                 })
    ri.Cylinder(metal_radius, 0, metal_height, 360)
    ri.AttributeEnd()
    ri.TransformEnd()

    #------------------!metal part!------------------#

    #------------------plastic part------------------#
    # base for bowly shaped part
    baseColorPlastic = [0.2,0.2,0.8]
    
    ri.TransformBegin()
    ri.Translate(0, metal_height, 0)
    ri.TransformBegin()
    ri.AttributeBegin()
    ri.Rotate(-90, 1, 0, 0)
    disk_radius = 0.465
    ri.Bxdf( "PxrDisney","bxdf", { 
                                  "color baseColor" : baseColorPlastic,
                                  "float clearcoat" : [1],
                                  "float roughness" : [0]
                                 })
    ri.Disk(0, disk_radius, 360)
    ri.AttributeEnd()
    ri.TransformEnd()

    # bowly shaped part
    ri.TransformBegin()
    ri.AttributeBegin()
    bowl_radius = 0.47
    ri.Translate(0, -0.05, 0)
    ri.Rotate(-90, 1, 0, 0)
    y_max = 0.433
    y_min = 0.05
    ri.Pattern("PxrBump","plasticBump",{
                                    "string filename" : "scratch.tx",
                                    "float scale": 0.003,
                                    "int invertT" : 0
                                })
    ri.Bxdf( "PxrDisney","bxdf", { 
                                  "color baseColor" : baseColorPlastic,
                                  "reference normal bumpNormal" : ["plasticBump:resultN"],
                                  "float clearcoat" : [1],
                                  "float specular" : [1],
                                  "float roughness" : [0]
                                 })
    ri.Sphere(bowl_radius, y_min, y_max, 360)
    ri.AttributeEnd()
    ri.TransformEnd()

    # plastic main body
    ri.TransformBegin()
    ri.Translate(0, y_max - y_min - 0.05, 0)
    ri.AttributeBegin()
    body_height = 0.7
    body_br = 0.2
    body_tr = 0.15
    ri.Attribute("trace", {
        "displacements" : [1]
    })
    ri.Attribute("displacementbound", {
        "sphere" : [1],
        "coordinatesystem" : ["shader"]
    })
    ri.Pattern("PxrOSL","diskTx", {
                                        "string shader"  : "randomDisk" 
                                      })
    ri.Displacement( "doDisplace", {
        "float disp" : [0.1],
        "reference float dispScalar" : ["diskTx:resultF"],
        "float atten" : [1]
    })
    ri.Bxdf( "PxrDisney","bxdf", { 
                                  "color baseColor" : baseColorPlastic,
                                  "float clearcoat" : [1],
                                  "float roughness" : [0]
                                 })
    hyperboloid_wrapper(body_height, body_br, body_tr)
    ri.AttributeEnd()

    # top base (tb)
    ri.TransformBegin()
    ri.Translate(0, body_height, 0)
    ri.AttributeBegin()
    tb_height = 0.08
    tb_tr = 0.375
    ri.Bxdf( "PxrDisney","bxdf", { 
                                  "color baseColor" : baseColorPlastic,
                                  "float clearcoat" : [1],
                                  "float roughness" : [0]
                                 })
    hyperboloid_wrapper(tb_height, body_tr, tb_tr)
    ri.AttributeEnd()

    # top top (tt)
    ri.TransformBegin()
    ri.AttributeBegin()
    ri.Translate(0, tb_height, 0)
    tt_tr = 0.35
    ri.Pattern("PxrBump","plasticBump",{
                                "string filename" : "scratch.tx",
                                "float scale": 0.003,
                                "int invertT" : 0
                            })
    ri.Bxdf( "PxrDisney","bxdf", { 
                                  "color baseColor" : baseColorPlastic,
                                  "reference normal bumpNormal" : ["plasticBump:resultN"],
                                  "float clearcoat" : [1],
                                  "float roughness" : [0]
                                 })
    hyperboloid_wrapper(tb_height, tb_tr, tt_tr)
    ri.AttributeEnd()

    # top cup (tc)
    ri.TransformBegin()
    ri.AttributeBegin()
    ri.Translate(0, tb_height, 0)
    ri.Rotate(-90, 1, 0, 0)
    tc_radius = tt_tr
    ri.Bxdf( "PxrDisney","bxdf", { 
                                  "color baseColor" : baseColorPlastic,
                                  "float clearcoat" : [1],
                                  "float roughness" : [0]
                                 })
    ri.Disk(0, tc_radius, 360)
    ri.AttributeEnd()

    ri.TransformEnd()
    ri.TransformEnd()
    ri.TransformEnd()
    ri.TransformEnd()
    ri.TransformEnd()
    ri.TransformEnd()
    #-----------------!plastic part!-----------------#

    ri.ArchiveRecord(ri.COMMENT, '--!End of Pin Function!--')

def Table():
    ri.ArchiveRecord(ri.COMMENT, '--Table Model Generated by Table Function--')
    ri.AttributeBegin()
    face = [15, 0, 10, 15, 0, -10, -15, 0, 10, -15, 0, -10]
    ri.Bxdf( "PxrDisney","bxdf", { 
                                  "color baseColor" : [0.7, 0.7, 0.8], 
                                 })
    ri.Patch("bilinear",{'P':face})
    ri.AttributeEnd()
    ri.ArchiveRecord(ri.COMMENT, '--!End of Table Function!--')

###-------------------------End of Function Section-------------------------###
# check and compile shaders
checkAndCompileShader('randomDisk')

# create an instance for the RenderMan interface
ri = prman.Ri()

# make the generated RIB file nicely indented
ri.Option("rib", {"string asciistyle": "indented"})

filename = "scene.rib"
# begin of RIB archive
ri.Begin(filename)

ri.ArchiveRecord(ri.COMMENT, 'File ' +filename)
ri.ArchiveRecord(ri.COMMENT, "Created by " + getpass.getuser())
ri.ArchiveRecord(ri.COMMENT, "Creation Date: " +time.ctime(time.time()))


# TO FRAME BUFFER
ri.Display("scene.exr", "it", "rgba")
ri.Format(1280,720,1)

#Fix the sampling to 720 to reduce noise, put pixel variance low for better look. 
ri.Hider("raytrace" ,{"int incremental" :[1], "int maxsamples" : 256, "int minsamples" : 256 })
ri.PixelVariance (0.01)
ri.ShadingRate(10)

#Use default to model, makes it easier.
# ri.Integrator ("PxrDefault" , "integrator")

#Path tracer for final lighting and shading.
ri.Integrator ("PxrVCM" ,"integrator")
ri.Integrator ("PxrDirectLighting" ,"integrator") 
ri.Integrator ("PxrPathTracer" ,"integrator")

# now set the projection to perspective
ri.Projection(ri.PERSPECTIVE,{ri.FOV:30} )

#Move our camera into place.
ri.Rotate(-25,1,0,0)
ri.Translate(0,-4,6)

# Begin The World
ri.WorldBegin()

#-------------------Lights--------------------
#Add a few lights to brighten up the scene. 
ri.AttributeBegin()
ri.Declare("areaLight" ,"string")
ri.AreaLightSource( "PxrStdAreaLight", {ri.HANDLEID:"areaLight", 
                                        "float exposure" : [10]
                                       })

ri.Bxdf( "PxrDisney","bxdf", { 
                        "color emitColor" : [ 1,1,1]
                        })
#Light 1 (South West)
ri.TransformBegin()
ri.Translate(10, 8,4)
ri.Scale(4,4,4)
ri.Geometry("spherelight")
ri.TransformEnd()
#Light 2 (North East)
ri.TransformBegin()
ri.Translate(-10, 8,4)
ri.Scale(4,4,4)
ri.Geometry("spherelight")
ri.TransformEnd()
ri.TransformBegin()
#Light 3 (South East)
ri.Translate(10,8,-8)
ri.Scale(4,4,4)
ri.Geometry("spherelight")
ri.TransformEnd()
ri.AttributeEnd()
#-------------------!Lights--------------------

# the groundplane
Table()

# create and move the pin
ri.TransformBegin()
# ri.Scale(5, 5, 5)
ri.Rotate(30, 1, 0, 0)
Pin()
ri.TransformEnd()

# end of the world
ri.WorldEnd()

# end of rib file
ri.End()
